import { useEffect, useCallback, useRef } from 'react';
import socket from '../socket';

export const useSocketEvents = (roomId, updateGameState, updateBankState, updateProfessionState, updateFreedomState, updateExitState) => {
  const eventHandlers = useRef(new Map());

  // Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ° ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
  const registerEventHandler = useCallback((event, handler) => {
    if (eventHandlers.current.has(event)) {
      socket.off(event, eventHandlers.current.get(event));
    }
    eventHandlers.current.set(event, handler);
    socket.on(event, handler);
  }, []);

  // ÐžÑ‚Ð¼ÐµÐ½Ð° Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ° ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
  const unregisterEventHandler = useCallback((event) => {
    if (eventHandlers.current.has(event)) {
      socket.off(event, eventHandlers.current.get(event));
      eventHandlers.current.delete(event);
    }
  }, []);

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
  const handleConnect = useCallback(() => {
    console.log('ðŸ”„ [Socket] Connected, syncing game state');
    console.log('ðŸ”„ [Socket] RoomId:', roomId);
    
    // Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹ Ð¸ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²
    socket.emit('getRoom', roomId);
    socket.emit('getPlayers', roomId);
    
    // ÐÐ• Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÐ¼ joinRoom Ð±ÐµÐ· playerData - ÑÑ‚Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²
    // socket.emit('joinRoom', roomId);
    
    // Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð² Ñ‡ÐµÑ€ÐµÐ· Ð½ÐµÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ
    setTimeout(() => {
      console.log('ðŸ”„ [Socket] Requesting players list again...');
      socket.emit('getPlayers', roomId);
    }, 1000);
  }, [roomId]);

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
  const handleDisconnect = useCallback((reason) => {
    console.log('ðŸ”„ [Socket] Disconnected:', reason);
    updateGameState(prevState => ({
      ...prevState, // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²ÑÐµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
      isMyTurn: false, 
      currentTurn: null 
    }));
  }, [updateGameState]);

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
  const handleConnectError = useCallback((error) => {
    console.error('ðŸ”„ [Socket] Connection error:', error);
  }, []);

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÑÐ¿Ð¸ÑÐºÐ° Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²
  const handlePlayersList = useCallback((playersList) => {
    console.log('ðŸŽ¯ [playersList] received:', playersList);
    console.log('ðŸŽ¯ [playersList] type:', typeof playersList);
    console.log('ðŸŽ¯ [playersList] isArray:', Array.isArray(playersList));
    console.log('ðŸŽ¯ [playersList] length:', playersList?.length);
    console.log('ðŸŽ¯ [playersList] roomId:', roomId);
    console.log('ðŸŽ¯ [playersList] socket.id:', socket.id);
    
    // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ myId Ð¿Ð¾ username Ð¸Ð· localStorage Ð¸Ð»Ð¸ Ð¿Ð¾ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ
    let myId = null;
    let currentPlayer = null;
    
    // ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð½Ð°Ð¹Ñ‚Ð¸ Ð¸Ð³Ñ€Ð¾ÐºÐ° Ð¿Ð¾ username Ð¸Ð· localStorage
    const savedUsername = localStorage.getItem('potok-deneg_username');
    console.log('ðŸŽ¯ [playersList] Saved username from localStorage:', savedUsername);
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð½Ñ‹Ð¹ username Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ
    if (savedUsername) {
      currentPlayer = playersList.find(p => p.username === savedUsername);
      if (currentPlayer) {
        myId = currentPlayer.id;
        console.log('ðŸŽ¯ [playersList] Found player by username:', currentPlayer.username, 'ID:', myId);
      } else {
        console.log('ðŸŽ¯ [playersList] Username not found in players list, clearing localStorage');
        localStorage.removeItem('potok-deneg_username');
      }
    }
    
    // Ð•ÑÐ»Ð¸ Ð½Ðµ Ð½Ð°ÑˆÐ»Ð¸, Ð¸Ñ‰ÐµÐ¼ Ð¿Ð¾ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ Ð¸Ð· ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð°
    if (!myId && playersList.length > 0) {
      // ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð½Ð°Ð¹Ñ‚Ð¸ Ð¸Ð³Ñ€Ð¾ÐºÐ° Ð¿Ð¾ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ (ÐµÑÐ»Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½)
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
      if (currentUser.username) {
        currentPlayer = playersList.find(p => p.username === currentUser.username);
        if (currentPlayer) {
          myId = currentPlayer.id;
          console.log('ðŸŽ¯ [playersList] Found player by currentUser:', currentPlayer.username, 'ID:', myId);
          
          // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ username Ð² localStorage
          localStorage.setItem('potok-deneg_username', currentPlayer.username);
          console.log('ðŸŽ¯ [playersList] Saved correct username to localStorage:', currentPlayer.username);
        }
      }
      
      // Ð•ÑÐ»Ð¸ Ð²ÑÐµ ÐµÑ‰Ðµ Ð½Ðµ Ð½Ð°ÑˆÐ»Ð¸, Ð±ÐµÑ€ÐµÐ¼ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Ð¸Ð³Ñ€Ð¾ÐºÐ° (Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ)
      if (!myId) {
        currentPlayer = playersList[0];
        myId = currentPlayer.id;
        console.log('ðŸŽ¯ [playersList] Using first player as current:', currentPlayer.username, 'ID:', myId);
        
        // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ username Ð² localStorage Ð´Ð»Ñ Ð±ÑƒÐ´ÑƒÑ‰Ð¸Ñ… Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¹
        localStorage.setItem('potok-deneg_username', currentPlayer.username);
        console.log('ðŸŽ¯ [playersList] Saved username to localStorage:', currentPlayer.username);
      }
    }
    
    console.log('ðŸŽ¯ [playersList] Final myId:', myId, 'currentPlayer:', currentPlayer?.username);
    console.log('ðŸŽ¯ [playersList] Players list:', playersList.map(p => ({ username: p.username, id: p.id })));
    
    updateGameState((prevState) => {
      const isMyTurn = currentPlayer ? currentPlayer.id === prevState.currentTurn : false;
      console.log('ðŸŽ¯ [playersList] ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ:', { 
        playersCount: playersList.length,
        myId, 
        currentTurn: prevState.currentTurn,
        isMyTurn 
      });
      
      const newState = {
        ...prevState, // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²ÑÐµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
        players: playersList,
        myId: myId,
        isMyTurn: isMyTurn,
        turnBanner: isMyTurn ? 'Ð’Ð°Ñˆ Ñ…Ð¾Ð´' : 'ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ñ…Ð¾Ð´Ð°'
      };
      
      console.log('ðŸŽ¯ [playersList] ÐÐ¾Ð²Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ:', newState);
      console.log('ðŸŽ¯ [playersList] players type:', typeof newState.players);
      console.log('ðŸŽ¯ [playersList] players isArray:', Array.isArray(newState.players));
      console.log('ðŸŽ¯ [playersList] myId:', myId);
      console.log('ðŸŽ¯ [playersList] isMyTurn:', isMyTurn);
      
      return newState;
    });
  }, [updateGameState]);

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²
  const handlePlayersUpdate = useCallback((playersList) => {
    console.log('[playersUpdate] received:', playersList);
    console.log('[playersUpdate] type:', typeof playersList);
    console.log('[playersUpdate] isArray:', Array.isArray(playersList));
    console.log('[playersUpdate] length:', playersList?.length);
    
    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ†Ð²ÐµÑ‚Ð° Ð¸Ð³Ñ€Ð¾ÐºÐ°Ð¼ Ð´Ð»Ñ Ð²Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð¸Ñ
    const playersWithColors = playersList.map((player, index) => {
      if (!player.color) {
        player.color = ['#FF7043', '#4CAF50', '#2196F3', '#9C27B0', '#FF9800', '#795548'][index % 6];
      }
      return player;
    });
    
    console.log('[playersUpdate] ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ñ Ð¸Ð³Ñ€Ð¾ÐºÐ°Ð¼Ð¸:', playersWithColors);
    console.log('[playersUpdate] playersWithColors type:', typeof playersWithColors);
    console.log('[playersUpdate] playersWithColors isArray:', Array.isArray(playersWithColors));
    
    // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ myId Ð¿Ð¾ username Ð¸Ð· localStorage Ð¸Ð»Ð¸ Ð¿Ð¾ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ
    let myId = null;
    let currentPlayer = null;
    const savedUsername = localStorage.getItem('potok-deneg_username');
    console.log('ðŸŽ¯ [playersUpdate] Saved username from localStorage:', savedUsername);
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð½Ñ‹Ð¹ username Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ
    if (savedUsername) {
      currentPlayer = playersWithColors.find(p => p.username === savedUsername);
      if (currentPlayer) {
        myId = currentPlayer.id;
        console.log('ðŸŽ¯ [playersUpdate] Found player by username:', currentPlayer.username, 'ID:', myId);
      } else {
        console.log('ðŸŽ¯ [playersUpdate] Username not found in players list, clearing localStorage');
        localStorage.removeItem('potok-deneg_username');
      }
    }
    
    // Ð•ÑÐ»Ð¸ Ð½Ðµ Ð½Ð°ÑˆÐ»Ð¸, Ð¸Ñ‰ÐµÐ¼ Ð¿Ð¾ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ Ð¸Ð· ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð°
    if (!myId) {
      // ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð½Ð°Ð¹Ñ‚Ð¸ Ð¸Ð³Ñ€Ð¾ÐºÐ° Ð¿Ð¾ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¼Ñƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ (ÐµÑÐ»Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½)
      const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
      if (currentUser.username) {
        currentPlayer = playersWithColors.find(p => p.username === currentUser.username);
        if (currentPlayer) {
          myId = currentPlayer.id;
          console.log('ðŸŽ¯ [playersUpdate] Found player by currentUser:', currentPlayer.username, 'ID:', myId);
          
          // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ username Ð² localStorage
          localStorage.setItem('potok-deneg_username', currentPlayer.username);
          console.log('ðŸŽ¯ [playersUpdate] Saved correct username to localStorage:', currentPlayer.username);
        }
      }
    }
    
    // Ð•ÑÐ»Ð¸ Ð²ÑÐµ ÐµÑ‰Ðµ Ð½Ðµ Ð½Ð°ÑˆÐ»Ð¸, ÐÐ• Ð±ÐµÑ€ÐµÐ¼ Ð¿ÐµÑ€Ð²Ð¾Ð³Ð¾ Ð¸Ð³Ñ€Ð¾ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸
    if (!myId) {
      console.log('âŒ [playersUpdate] Could not identify current player from players list');
      console.log('âŒ [playersUpdate] Available players:', playersWithColors.map(p => ({ username: p.username, id: p.id })));
      console.log('âŒ [playersUpdate] Current user from localStorage:', JSON.parse(localStorage.getItem('currentUser') || '{}'));
      console.log('âŒ [playersUpdate] Saved username from localStorage:', savedUsername);
    }
    
    console.log('ðŸŽ¯ [playersUpdate] Final myId:', myId, 'currentPlayer:', currentPlayer?.username);
    console.log('ðŸŽ¯ [playersUpdate] Players list:', playersWithColors.map(p => ({ username: p.username, id: p.id, profession: p.profession?.name })));
    
    // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð¸Ð³Ñ€Ñ‹ Ñ Ð½Ð¾Ð²Ñ‹Ð¼ ÑÐ¿Ð¸ÑÐºÐ¾Ð¼ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²
    updateGameState((prevState) => {
      const isMyTurn = currentPlayer ? currentPlayer.id === prevState.currentTurn : false;
      console.log('ðŸŽ¯ [playersUpdate] ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ:', { 
        playersCount: playersWithColors.length,
        myId, 
        currentTurn: prevState.currentTurn,
        isMyTurn 
      });
      
      const newState = {
        ...prevState, // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²ÑÐµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
        players: playersWithColors,
        myId: myId,
        isMyTurn: isMyTurn,
        turnBanner: isMyTurn ? 'Ð’Ð°Ñˆ Ñ…Ð¾Ð´' : 'ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ñ…Ð¾Ð´Ð°'
      };
      
      console.log('ðŸŽ¯ [playersUpdate] ÐÐ¾Ð²Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ:', newState);
      console.log('ðŸŽ¯ [playersUpdate] players type:', typeof newState.players);
      console.log('ðŸŽ¯ [playersUpdate] players isArray:', Array.isArray(newState.players));
      console.log('ðŸŽ¯ [playersUpdate] myId:', myId);
      console.log('ðŸŽ¯ [playersUpdate] isMyTurn:', isMyTurn);
      
      return newState;
    });
  }, [updateGameState]);

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ñ…Ð¾Ð´Ð°
  const handleTurnChanged = useCallback((playerId) => {
    console.log('ðŸ”„ [turnChanged] received:', { playerId, socketId: socket.id, roomId });
    
    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ñ‡ÐµÑ€ÐµÐ· updateGameState
    updateGameState((prevState) => {
      const isMyTurn = playerId === prevState.myId;
      console.log('ðŸ”„ [turnChanged] ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ:', { 
        playerId, 
        myId: prevState.myId, 
        isMyTurn,
        roomId
      });
      
      return {
        ...prevState, // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²ÑÐµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ (Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ players)
        currentTurn: playerId,
        isMyTurn: isMyTurn,
        turnBanner: isMyTurn ? 'Ð’Ð°Ñˆ Ñ…Ð¾Ð´' : 'ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ñ…Ð¾Ð´Ð°'
      };
    });
    
    // Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€ Ñ…Ð¾Ð´Ð° ÐµÑÐ»Ð¸ ÑÑ‚Ð¾ Ð¼Ð¾Ð¹ Ñ…Ð¾Ð´
    updateGameState((prevState) => {
      const newTimerState = { 
        ...prevState, // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²ÑÐµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
        turnTimer: 120 
      };
      console.log('ðŸ”„ [turnChanged] Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ñ‚Ð°Ð¹Ð¼ÐµÑ€:', newTimerState);
      return newTimerState;
    });
  }, [updateGameState]);

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð´Ð°Ð½Ð½Ñ‹Ñ… ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹
  const handleRoomData = useCallback((data) => {
    console.log('[roomData] received:', data);
    
    updateGameState((prevState) => {
      const isMyTurn = data.currentTurn === prevState.myId;
      console.log('ðŸ  [roomData] ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ:', { 
        currentTurn: data.currentTurn, 
        myId: prevState.myId, 
        isMyTurn,
        roomId,
        playersCount: data.players?.length || 0
      });
      
      const newState = {
        ...prevState, // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²ÑÐµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ (Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ players)
        currentTurn: data.currentTurn,
        isMyTurn: isMyTurn,
        turnTimer: 120,
        turnBanner: isMyTurn ? 'Ð’Ð°Ñˆ Ñ…Ð¾Ð´' : 'ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ñ…Ð¾Ð´Ð°'
      };
      
      // Ð•ÑÐ»Ð¸ Ð² Ð´Ð°Ð½Ð½Ñ‹Ñ… ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹ ÐµÑÑ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð², Ð¾Ð±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐµÐ³Ð¾
      if (data.players && Array.isArray(data.players)) {
        newState.players = data.players;
        console.log('ðŸ  [roomData] ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²:', data.players);
      }
      
      console.log('ðŸ  [roomData] ÐÐ¾Ð²Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ:', newState);
      return newState;
    });
  }, [updateGameState]);

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¸Ð³Ñ€Ñ‹
  const handleGameStarted = useCallback(() => {
    console.log('ðŸŽ® [gameStarted] received for room:', roomId);
    
    // ÐŸÐµÑ€ÐµÐ·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð² Ð¸ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ñ‹
    console.log('ðŸŽ® [gameStarted] Requesting players and room data...');
    socket.emit('getPlayers', roomId);
    socket.emit('getRoom', roomId);
    
    // Ð¢Ð°ÐºÐ¶Ðµ Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²
    socket.emit('getPlayers', roomId);
    
    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÑƒÑŽ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÑƒ Ð¸ ÑÐ½Ð¾Ð²Ð° Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼
    setTimeout(() => {
      console.log('ðŸŽ® [gameStarted] Delayed request for players...');
      socket.emit('getPlayers', roomId);
    }, 500);
  }, [roomId]);

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð²Ñ‹Ð±Ð¾Ñ€Ð° ÑÐ´ÐµÐ»ÐºÐ¸
  const handleDealChoice = useCallback(({ playerId, cellType, position, balance, monthlyCashflow }) => {
    console.log('dealChoice received:', { playerId, myId: updateGameState.myId });
    
    updateGameState(prevState => ({
      ...prevState, // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²ÑÐµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
      modal: {
        type: 'dealChoice',
        details: {
          cellType,
          position,
          balance,
          monthlyCashflow,
          maxLoan: monthlyCashflow * 10
        }
      }
    }));
  }, [updateGameState]);

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ°Ñ€Ñ‚Ñ‹ ÑÐ´ÐµÐ»ÐºÐ¸
  const handleDealCard = useCallback(({ card, type, playerId, balance, maxLoan, canAfford, needsLoan }) => {
    console.log('dealCard received:', { playerId, myId: updateGameState.myId });
    
    updateGameState(prevState => ({
      ...prevState, // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²ÑÐµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
      modal: {
        type: 'dealCard',
        details: {
          card,
          type,
          balance,
          maxLoan,
          canAfford,
          needsLoan
        }
      }
    }));
  }, [updateGameState]);

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÑƒÐ¿Ð»ÐµÐ½Ð½Ð¾Ð¹ ÑÐ´ÐµÐ»ÐºÐ¸
  const handleDealBought = useCallback(({ playerId, card, newBalance, newPassiveIncome }) => {
    updateGameState(prevState => ({
      ...prevState, // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²ÑÐµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
      modal: {
        type: 'dealBought',
        details: {
          card,
          newBalance,
          newPassiveIncome
        }
      }
    }));
  }, [updateGameState]);

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¾ÑˆÐ¸Ð±ÐºÐ¸ ÑÐ´ÐµÐ»ÐºÐ¸
  const handleDealError = useCallback(({ message }) => {
    updateGameState(prevState => ({
      ...prevState, // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²ÑÐµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
      modal: {
        type: 'error',
        details: { message }
      }
    }));
  }, [updateGameState]);

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ ÑÐ´ÐµÐ»ÐºÐ¸
  const handleDealEvent = useCallback(({ card, type }) => {
    updateGameState(prevState => ({
      ...prevState, // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²ÑÐµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
      modal: {
        type: 'deal',
        details: { card, dealType: type }
      }
    }));
  }, [updateGameState]);

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ñ‚Ð°Ð¹Ð¼ÐµÑ€Ð° Ñ…Ð¾Ð´Ð°
  const handleTurnTimerUpdate = useCallback((data) => {
    console.log('â° [turnTimerUpdate] received:', data);
    console.log('â° [turnTimerUpdate] roomId:', roomId);
    console.log('â° [turnTimerUpdate] socket.id:', socket.id);
    
    updateGameState(prev => {
      const newState = {
        ...prev, // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²ÑÐµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ (Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ players)
        turnTimer: data.remaining,
        isTimerActive: data.isActive,
        currentTurn: data.playerId
      };
      
      console.log('â° [turnTimerUpdate] ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ:', newState);
      return newState;
    });
  }, [updateGameState, roomId]);

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¸Ð³Ñ€Ð¾ÐºÐ°
  const handlePlayerUpdated = useCallback((player) => {
    console.log('[playerUpdated]', player.id);
    
    updateGameState(prev => {
      const exists = prev.players.some(p => p.id === player.id);
      const newPlayers = exists 
        ? prev.players.map(p => (p.id === player.id ? player : p))
        : [...prev.players, player];
      
      return { 
        ...prev, // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²ÑÐµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
        players: newPlayers 
      };
    });
  }, [updateGameState]);

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸ Ð¸Ð³Ñ€Ð¾ÐºÐ°
  const handlePlayerPositionUpdated = useCallback(({ playerId, position, cellType }) => {
    console.log('[playerPositionUpdated]', { playerId, position, cellType });
    
    updateGameState(prev => ({
      ...prev, // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð²ÑÐµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
      players: prev.players.map(p => p.id === playerId ? { ...p, position } : p)
    }));
    
    if (playerId === updateGameState.myId) {
      // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚Ð¸Ð¿ ÐºÐ»ÐµÑ‚ÐºÐ¸ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸ Ð´Ð»Ñ Ð¼Ð°Ð»Ð¾Ð³Ð¾ ÐºÑ€ÑƒÐ³Ð°
      let cellType = 'small';
      if (position >= 0 && position <= 23) {
        cellType = 'outer';
      } else if (position >= 24 && position <= 47) {
        cellType = 'inner';
      }
      
      console.log('[playerPositionUpdated] Player moved to:', { position, cellType });
    }
  }, [updateGameState]);

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ñ Ð¾Ñ‡ÐµÑ€ÐµÐ´Ð½Ð¾ÑÑ‚Ð¸
  const handleOrderDeterminationStarted = useCallback((orderData) => {
    console.log('ðŸŽ¯ [orderDeterminationStarted] received:', orderData);
    
    if (orderData.players && Array.isArray(orderData.players)) {
      // ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð² Ð² Ð½ÑƒÐ¶Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚
      const players = orderData.players.map(p => ({
        id: p.id,
        username: p.username,
        ready: true,
        roomId: roomId
      }));
      
      console.log('ðŸŽ¯ [orderDeterminationStarted] ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¸Ð³Ñ€Ð¾ÐºÐ¾Ð²:', players);
      
      updateGameState(prev => ({
        ...prev,
        players: players
      }));
    }
  }, [updateGameState, roomId]);

  // Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð²ÑÐµÑ… Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¾Ð² ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹
  useEffect(() => {
    registerEventHandler('connect', handleConnect);
    registerEventHandler('disconnect', handleDisconnect);
    registerEventHandler('connect_error', handleConnectError);
    registerEventHandler('playersList', handlePlayersList);
    registerEventHandler('playersUpdate', handlePlayersUpdate);
    registerEventHandler('turnChanged', handleTurnChanged);
    registerEventHandler('roomData', handleRoomData);
    registerEventHandler('gameStarted', handleGameStarted);
    registerEventHandler('dealChoice', handleDealChoice);
    registerEventHandler('dealCard', handleDealCard);
    registerEventHandler('dealBought', handleDealBought);
    registerEventHandler('dealError', handleDealError);
    registerEventHandler('dealEvent', handleDealEvent);
    registerEventHandler('turnTimerUpdate', handleTurnTimerUpdate);
    registerEventHandler('playerUpdated', handlePlayerUpdated);
    registerEventHandler('playerPositionUpdated', handlePlayerPositionUpdated);
    registerEventHandler('orderDeterminationStarted', handleOrderDeterminationStarted);

    // ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ñ€Ð¸ Ñ€Ð°Ð·Ð¼Ð¾Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¸
    return () => {
      eventHandlers.current.forEach((handler, event) => {
        socket.off(event, handler);
      });
      eventHandlers.current.clear();
    };
  }, [
    roomId,
    registerEventHandler,
    handleConnect,
    handleDisconnect,
    handleConnectError,
    handlePlayersList,
    handlePlayersUpdate,
    handleTurnChanged,
    handleRoomData,
    handleGameStarted,
    handleDealChoice,
    handleDealCard,
    handleDealBought,
    handleDealError,
    handleDealEvent,
    handleTurnTimerUpdate,
    handlePlayerUpdated,
    handlePlayerPositionUpdated,
    handleOrderDeterminationStarted
  ]);

  return {
    registerEventHandler,
    unregisterEventHandler
  };
};
